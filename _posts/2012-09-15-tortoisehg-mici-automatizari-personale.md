---
layout: post
title:  "TortoiseHg - mici automatizari personale"
date:   2012-09-13 00:00:01
comments: true
categories: Dev-tools
---

Ca si sistem [DVCS](http://en.wikipedia.org/wiki/Distributed_version_control_system) pentru proiectele software folosesc [Mercurial](http://mercurial.selenic.com/), cu [Bitbucket](https://bitbucket.org/) pe post de repository online. [TortoiseHg](http://tortoisehg.bitbucket.org/) este doar o interfata grafica pentru Mercurial (acesta din urma opereaza in linie de comanda). In plus, ca sa lucrez direct din Visual Studio, folosesc [VisualHg](http://visualhg.codeplex.com/). Dupa 2 ani de lucru intr-un astfel de "environment", am ajuns sa identific cateva cerinte care sa-mi usureze (automatizeze) munca.  Aceste cerinte dar si solutiile aferente le prezint mai jos:

## Cerinte: ##

- nu vreau ca la fiecare proiect nou creat sa creez si sa configurez un fisier `.hgignore`
- vreau ca dupa fiecare "pull" de la Bitbucket sa se faca "update" automat
- vreau ca dupa fiecare "commit" sa se faca "push" automat pe Bitbucket
- vreau sa nu mai introduc informatiile de autentificare la fiecare "pull" sau "push"

## Rezolvare: ##

Presupunand ca e vorba de prima instalare, pasii ar fi urmatorii:

### 1. Instalez TortoiseHg  ###
Instalarea se face cu "Next, Next". Se instaleaza automat si Mercurial.

### 2. Aplic setarile globale (automatizari pt. push, pull si autentificare) ###

Creez in directorul utilizatorului current (Ex: C:Users\lmaran) un fisier de tip text, il numesc **mercurial.ini** (obligatoriu asa) si adaug urmatorul continut:

```
# Generated by TortoiseHg setting dialog

[ui]
username = Lucian Maran
ignore = %USERPROFILE%/myhgignore.txt

[tortoisehg]
# automatic update after pull
postpull = update
# automatic push after commit
cipushafter = default

# detalii despre autentificare automata - http://stackoverflow.com/questions/2584407/how-to-save-username-and-password-with-mercurial
[auth]
bitbucket.prefix = https://bitbucket.org
bitbucket.username = lmaran
bitbucket.password = mypsw
```

Obs:

- Actualizeaza usr+psw in fisierul de mai sus.
- Fisierul **mercurial.ini** reprezinta locul in care Mercurial memoreaza toate setarile **globale** (setarile valabile pt. toate repository-urile locale). Acest fisier se poate crea manual (ca mai sus) sau se creaza automat, la prima setare globala salvata din mediul graphic (TortoiseHg -> Global Settings). O parte din setarile de mai sus se pot actualize si din interfata grafica, dar eu prefer variant "text".

### 3. Aplic setarile globale (pt .hgignore) ###

Creez in acelasi director (Ex: C:Users\lmaran) un fisier de tip text, il numesc myhgignore.txt (calea si numele fisierului pot sa difere, dar trebuie sa corespunda cu valoarea declarata in mercurial.ini) si adaug urmatorul continut:

```
syntax: glob

*.suo
*.csproj.user
obj
bin
```

Obs:

- [Aici](http://stackoverflow.com/questions/34784/mercurial-hgignore-for-visual-studio-2008-projects/2555413#2555413) sunt prezentate alte exemple de fisiere/foldere care ar putea fi omise de la versionare.
- In felul acesta, prezenta fisierului .hgignore in radacina folder-ului versionat nu mai este necesara.

In acest moment am facut toate setarile **globale**. Mai ramane sa cream primul repository **local** si sa definim pentru acesta calea pentru pull/push de la, respectiv catre, repository-ul extern cu care urmeaza sa se faca sincronizarea (Bitbucket).

### 4. Creez repository-ul local ###

Aceasta o pot face in 2 moduri:

**A.** Prin clonare, daca proiectul exista deja pe Bitbucket:

In folder-ul in care doresti sa fie clonat proiectul lansezi optiunea "Clone" si modifici adresa sursei (vezi si paragraful "Update" putin mai jos):

![](https://dl.dropboxusercontent.com/u/43065769/blog/images/2012/adrClone.png)

Dupa ce toate fisierele au fost copiate, la destinatie va apare noul folder si fisierele aferente:

![](https://dl.dropboxusercontent.com/u/43065769/blog/images/2012/result.png)

Obs: formatul adresei introdusa putin mai sus are un url standard, in care ultimul segment (in cazul de fata “eta2uapi“) reprezinta numele repository-ului asa cum a fost el introdus pe Bitbucket. Daca e greu de retinut, atunci poti copia acest URL chiar de pe Bitbucket:

![](https://dl.dropboxusercontent.com/u/43065769/blog/images/2012/BbCloneSource.png)

**Update:** Prefixul "*lmaran@*" (adica numele user-ului cu care se face conectarea la Bitbucket ) inclus in URL-ul prezentat mai sus putea fi omis. Acesta ar fi avut rolul ca, in fereastra de autentificare, numele user-ului sa fie completat automat (sa trebuiasca introdusa doar parola). Cum eu am definit atat user-ul cat si parola in sectiunea de setari globale, prezenta acestei informatii in cadrul URL-ului de conectare nu se mai justifica (fereastra de autentificare nici nu mai apare).

**B.** Prin "transformarea" unui folder obisnuit (uzual folder-ul care contine proiectul VisualStudio) intr-un repository local.

Pe folder-ul dorit (sau in radacina acestuia) se apeleaza meniul "Create Repository Here"):

Fata de setarile propuse, se debifeaza optiunea care propune crearea unui fisier `.hgignore` (locul in care sunt specificate fisierele care urmeaza a fi excluse de la versionare). De ce? Pentru ca aceste setari le-am definit odata la nivel global si se aplica pt. toate proiectele. Asta daca nu ai proiecte cu fisiere speciale pe care doresti sa le excluzi.

![](https://dl.dropboxusercontent.com/u/43065769/blog/images/2012/createcmd2.png)

In acest moment, repository-ul este creat, dar este gol. Dupa un "Commit" (si eventual un "Update Icons") obtinem un repository asemanator cu cel obtinut prin metoda clonarii:

![](https://dl.dropboxusercontent.com/u/43065769/blog/images/2012/repofinal.png)

Obs: Folder-ul ".hg" se gaseste in radacina fiecarui repository si contine toate informatiile care fac dintr-un folder obisnuit un folder cu versionare. Simpla stergere a acestuia readuce folder-ul la starea initiala si face sa dispara icoanele care sugereaza versionarea.

### 5. Aplic setarile locale (Bitbucket path) ###

Setarile locale se gasesc in fisierul "hgrc" din folderul ".hg" al fiecarui proiect.    Acest fisier poate fi editat manual (Notepad) sau din interfata grafica.

La mine, fisierul hgrc contine o singura setare, si anume calea catre repository-ul **extern** cu care repository-ul **local** se sincronizeaza:

```
[paths]
default = https://bitbucket.org/lmaran/eta2uapi
```

Aceeasi setare poate fi facuta si din interfata grafica (TortoiseHg -> Synchronize):

![](https://dl.dropboxusercontent.com/u/43065769/blog/images/2012/sync.png)

Obs:

- daca repository-ul local este creat prin **clonare**, aceasta setare este deja facuta (este de fapt chiar adresa de clonare)
- daca repository-ul locat este creat prin **transformarea** unui folder obisnuit, atunci setarea pt. "Bitbucket path" trebuie facuta manual, prin una din cele 2 metode prezentate mai sus.

Am documentat aceste lucruri pentru mine, dar poate ajuta si altora!